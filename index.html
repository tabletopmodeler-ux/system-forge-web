<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>System Forge ‚Äî Web (Upgraded)</title>
<style>
:root{
  --bg:#0b0f14; --panel:#111923; --text:#e7f0fb; --muted:#8aa0ba;
  --accent:#5cc8ff; --btn:#163047; --btn2:#1b2430; --border:#273446;
  --good:#7bd88f; --warn:#ffd166; --bad:#ff6b6b;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
.appbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#0d141d;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
.appbar .title{font-weight:700;letter-spacing:.3px}
.content{padding:12px;display:grid;gap:12px;grid-template-columns:1fr}
.controls{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
.controls .row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.controls label{color:var(--muted);font-size:14px}
.controls input, .controls select{background:#0f1a25;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
.controls button{background:var(--btn2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
.controls button.primary{background:var(--btn);border-color:#2b3d53}
.controls button:hover{filter:brightness(1.1)}
.stats{font-size:14px;color:var(--muted);padding:6px 2px}
.canvas-wrap{position:relative;background:#0f1720;border:1px solid var(--border);border-radius:12px;padding:6px;display:flex;justify-content:center;min-height:420px}
canvas{max-width:100%;height:auto;border-radius:8px;background:#0b111a;touch-action:manipulation}
.legend{position:absolute;right:10px;bottom:10px;background:#ffffffd0;color:#000;border:1px solid #888;border-radius:10px;padding:10px;max-width:min(60%,280px)}
.legend.hidden{display:none}
.legend .legend-title{font-weight:700;margin-bottom:6px}
.legend ul{margin:0;padding-left:18px;font-size:12px}
.legend li{margin:2px 0}
.detail-sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);transition:.25s transform ease; background:#0f1720;border-top:1px solid var(--border);box-shadow:0 -8px 24px rgba(0,0,0,.3);padding:12px 14px;z-index:20}
.detail-sheet.show{transform:translateY(0)}
.detail-row{display:grid;grid-template-columns:120px 1fr;gap:10px;margin:4px 0}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
.hab{font-weight:700;padding:2px 8px;border-radius:999px}
.hab.good{background:color-mix(in srgb, var(--good) 20%, transparent);border:1px solid var(--good);color:var(--good)}
.hab.ok{background:color-mix(in srgb, var(--warn) 20%, transparent);border:1px solid var(--warn);color:var(--warn)}
.hab.bad{background:color-mix(in srgb, var(--bad) 20%, transparent);border:1px solid var(--bad);color:var(--bad)}
.footer{padding:8px 12px;color:var(--muted);font-size:12px;text-align:center;border-top:1px solid var(--border)}
@media (min-width: 900px){
  .content{grid-template-columns:360px 1fr}
  .canvas-wrap{min-height:560px}
}
</style>
</head>
<body>
  <header class="appbar">
    <div class="title">System Forge</div>
  </header>

  <main class="content">
    <section class="controls">
      <div class="row">
        <label for="seed">Seed</label>
        <input id="seed" type="text" placeholder="AURORA-07731" value="AURORA-07731" />
        <button id="btnReroll" title="Randomize seed">üé≤</button>
      </div>
      <div class="row">
        <label for="preset">Preset</label>
        <select id="preset">
          <option>Hard Sci‚ÄëFi</option>
          <option selected>Space Opera</option>
          <option>Sparse</option>
          <option>Crowded</option>
        </select>
      </div>
      <div class="row">
        <button id="btnGenerate" class="primary">Generate</button>
        <button id="btnLegend">Legend</button>
        <button id="btnExportJSON">Export JSON</button>
        <button id="btnExportCSV">Export CSV</button>
        <button id="btnExportPNG">Export PNG</button>
      </div>
      <div id="stats" class="stats"></div>
    </section>

    <section class="canvas-wrap">
      <canvas id="map" width="900" height="900" aria-label="System map"></canvas>
      <div id="legend" class="legend hidden">
        <div class="legend-title">LEGEND</div>
        <ul>
          <li>‚òÖ Primary Star (color = spectral class)</li>
          <li>‚óê Secondary/Tertiary Star</li>
          <li>‚óè Terrestrial (blue), ‚óè Ocean (dark blue), ‚óè Ice (white/blue), ‚¨§ Gas (striped), ‚óè Dwarf (gray)</li>
          <li>‚Ä¢ Moon (small dot)</li>
          <li>( ) Rings</li>
          <li>¬∑¬∑¬∑ Asteroid Belt</li>
          <li>- - - Orbit Path</li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span id="footInfo">Classic Clean ‚Ä¢ Visual Upgrade ‚Ä¢ Tap a planet for details</span>
  </footer>

  <!-- Bottom sheet for details -->
  <div id="detailSheet" class="detail-sheet" role="dialog" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div id="detailTitle" style="font-weight:700">Planet</div>
      <button id="btnCopy" class="badge" title="Copy details">Copy</button>
    </div>
    <div class="detail-row"><div class="badge">Class</div><div id="dClass"></div></div>
    <div class="detail-row"><div class="badge">Bands</div><div id="dBands"></div></div>
    <div class="detail-row"><div class="badge">Atmos</div><div id="dAtmos"></div></div>
    <div class="detail-row"><div class="badge">Temp</div><div id="dTemp"></div></div>
    <div class="detail-row"><div class="badge">Water</div><div id="dWater"></div></div>
    <div class="detail-row"><div class="badge">Gravity</div><div id="dGrav"></div></div>
    <div class="detail-row"><div class="badge">Habitability</div><div id="dHab"></div></div>
    <div class="detail-row"><div class="badge">POIs</div><div id="dPOIs"></div></div>
    <div style="text-align:right;margin-top:6px">
      <button id="btnClose" class="badge">Close</button>
    </div>
  </div>

<script>
/*** Deterministic generator, upgraded renderer, selection & details ***/
function nfc(s){ return s.normalize('NFC'); }
function hash64(str){
  let h = 0xcbf29ce484222325n, p = 0x100000001b3n;
  const bytes = new TextEncoder().encode(str);
  for(const b of bytes){ h ^= BigInt(b); h = (h * p) & ((1n<<64n)-1n); }
  return h || 1n;
}
function splitSeed(seed){ return [hash64(seed), hash64(seed+"::salt")]; }
function XORShift128Plus(seedStr){
  let [s0, s1] = splitSeed(seedStr);
  function nextBig(){
    let x=s0, y=s1; s0=y; x^=x<<23n; x&=((1n<<64n)-1n); x^=x>>17n; x^=y; x^=y>>26n; s1=x;
    return (s0 + s1) & ((1n<<64n)-1n);
  }
  function next(){ return Number(nextBig() >> 11n) / Number(1n<<53n); }
  function randint(lo, hi){ return lo + Math.floor(next() * (hi-lo+1)); }
  function wchoice(items, weights){
    let t=weights.reduce((a,b)=>a+b,0), x=next()*t;
    for(let i=0;i<items.length;i++){ if(x<weights[i]) return items[i]; x-=weights[i]; }
    return items[items.length-1];
  }
  function choice(arr){ return arr[randint(0,arr.length-1)]; }
  return { next, randint, wchoice, choice };
}
const SPECTRAL = ["O","B","A","F","G","K","M"];
const PLANET = ["terrestrial","ocean","ice","gas","dwarf"];
const ATMOS = ["none","thin","breathable","thick","toxic"];
const TEMP = ["freeze","cold","temperate","warm","hot"];
const GRAV = ["low","earthlike","high"];
const SIZE = ["tiny","small","medium","large"];
const DENS = ["low","medium","high"];
const STAR_COLORS = {O:"#4BA3FF",B:"#9CCFFF",A:"#FFFFFF",F:"#FFF59D",G:"#FFD54F",K:"#FFB74D",M:"#EF5350"};
const PLANET_COLORS = {terrestrial:"#4FC3F7", ocean:"#0288D1", ice:"#E0F7FA", gas:"#FBC02D", dwarf:"#BDBDBD"};

function bandsForStar(spectral){
  let mass, lum, rad, color;
  if(["O","B"].includes(spectral)){ mass="large"; lum="high"; rad="large"; }
  else if(["A","F","G"].includes(spectral)){ mass="medium"; lum="medium"; rad="medium"; }
  else { mass="small"; lum="low"; rad="small"; }
  color = STAR_COLORS[spectral] || "#FFD54F";
  return {mass, lum, rad, color};
}
function habitabilityScore(cls, atmos, grav, temp, water){
  let s=0;
  if(cls==="terrestrial"||cls==="ocean") s+=30;
  if(atmos==="breathable") s+=30; else if(atmos==="thin") s+=10; else if(atmos==="thick") s+=5;
  if(grav==="earthlike") s+=20;
  if(temp==="temperate") s+=20; else if(temp==="warm"||temp==="cold") s+=10;
  if(water==="global") s+=10; else if(water==="patchy") s+=5;
  return Math.max(0, Math.min(100, s));
}
function genPOIs(rng, density){
  const count = rng.randint(0, Math.max(1, Math.min(5, density+2)));
  const names = {
    Cities:["Port Halcyon","Rimwatch","Glass Harbor","Low Dock"],
    Ruins:["Sundial Spire","Vault-13","Cinder Station","Nameless Gate"],
    Geology:["Glass Flats","Basalt Teeth","Crater Mare","Whispering Dunes"],
    Anomalies:["Grav Ripple","Signal Ghost","Aurora Node","Cold Spot"],
    Factions:["Free Miners","Archivists","Smugglers","Pilgrims"],
    Resources:["Iridium Veins","Chondrite Field","Hydrothermal Vent","Ice Quarries"]
  };
  const hooks = {
    Cities:"Customs backlog hides unusual cargo.",
    Ruins:"Ancient locks respond to new signals.",
    Geology:"Recent tremors reveal fresh strata.",
    Anomalies:"Sensors glitch with patterned noise.",
    Factions:"Recruiters seek off-world specialists.",
    Resources:"New claim jumpers provoke disputes."
  };
  const arr=[];
  for(let i=0;i<count;i++){
    const cats=["Cities","Ruins","Geology","Anomalies","Factions","Resources"];
    const cat=cats[Math.floor(Math.random()*cats.length)];
    const name = names[cat][Math.floor(Math.random()*4)];
    arr.push({id:`POI-${1000+Math.floor(Math.random()*9000)}`, category:cat, name, tags:[], hook:hooks[cat]});
  }
  return arr;
}
function generateSystem(seed, preset="Space Opera"){
  seed = nfc(seed);
  const rng = XORShift128Plus(seed);
  let starChoices, planetMin, planetMax, moonBias, poiDensity;
  switch(preset){
    case "Hard Sci‚ÄëFi": starChoices=[1,1,2]; planetMin=2; planetMax=8; moonBias=0.8; poiDensity=1; break;
    case "Sparse":     starChoices=[1,1,1,2]; planetMin=1; planetMax=6; moonBias=0.6; poiDensity=0; break;
    case "Crowded":    starChoices=[1,2,2,3]; planetMin=6; planetMax=12; moonBias=1.4; poiDensity=2; break;
    default:           starChoices=[1,2,2,3]; planetMin=4; planetMax=10; moonBias=1.2; poiDensity=2;
  }
  const starCount = starChoices[rng.randint(0, starChoices.length-1)];
  const stars=[];
  const weights=[1,2,3,5,7,9,10];
  for(let i=0;i<starCount;i++){
    let t=weights.reduce((a,b)=>a+b,0), x=rng.next()*t, spectral="G";
    for(let j=0;j<SPECTRAL.length;j++){ if(x<weights[j]) {spectral=SPECTRAL[j]; break;} x-=weights[j]; }
    const {mass, lum, rad, color} = bandsForStar(spectral);
    stars.push({ id:`STAR-${i+1}`, role:["Primary","Secondary","Tertiary"][i], spectral_class:spectral,
                 mass_band:mass, luminosity_band:lum, radius_band:rad, color_hint:color});
  }
  const nPlanets = rng.randint(planetMin, planetMax);
  const planets=[];
  let habitable=0, moonTotal=0;
  function wchoice(items,weights){
    let t=weights.reduce((a,b)=>a+b,0), x=rng.next()*t;
    for(let i=0;i<items.length;i++){ if(x<weights[i]) return items[i]; x-=weights[i]; }
    return items[items.length-1];
  }
  for(let idx=1; idx<=nPlanets; idx++){
    const pclass = wchoice(PLANET,[5,3,3,5,2]);
    const size = wchoice(SIZE,[2,3,3,2]);
    const mass = wchoice(SIZE,[2,3,3,2]);
    const density = wchoice(["low","medium","high"],[2,5,3]);
    const atmos = wchoice(ATMOS,[2,3,5,2,2]);
    const water = wchoice(["none","patchy","global"],[5,3,2]);
    const grav = wchoice(GRAV,[3,5,3]);
    const temp = wchoice(TEMP,[2,3,5,3,2]);
    const rings = (pclass==="gas") && (rng.next()<0.7 || preset==="Crowded");
    const base = {gas:[2,6], terrestrial:[0,2], ocean:[0,2], ice:[0,1], dwarf:[0,1]}[pclass];
    let mcount = Math.max(0, Math.round((base[0] + rng.next()*(base[1]-base[0]))*moonBias + (rng.next()-0.5)));
    moonTotal += mcount;
    const moons=[];
    const bands=["near","mid","far"];
    for(let m=0;m<mcount;m++){
      moons.push({id:`MN-${idx}${String.fromCharCode(65+m)}`, orbit_dist_band:bands[Math.min(2, Math.floor(rng.next()*3))], class:wchoice(["rock","ice","captured"],[6,3,1]), pois:[]});
    }
    const pois = genPOIs(rng, poiDensity);
    const hab = habitabilityScore(pclass, atmos, grav, temp, water);
    if(hab>=60) habitable++;
    planets.push({ id:`PL-${idx}`, orbit_index:idx, parent_star_id:"STAR-1", class:pclass, size_band:size, mass_band:mass, density_band:density,
                   atmosphere:atmos, surface_water:water, gravity_band:grav, temperature_band:temp, habitability_score:hab, rings:!!rings, moons, pois });
  }
  const belts=[];
  if((preset==="Space Opera"||preset==="Crowded") && nPlanets>=4 && (hash64(seed)&255n) < 204n){
    const dens = wchoice(["sparse","moderate","dense"],[3,5,2]);
    const comp = wchoice(["carbonaceous chondrites","silicaceous","metallic"],[5,3,2]);
    belts.push({id:"BELT-1", type:"belt", zone:(nPlanets>5?"outer":"inner"), density_band:dens, composition_hint:comp});
  }
  const now = new Date().toISOString().replace(/\.\d{3}Z$/,"Z");
  return {
    version:"1.0.0",
    app:"System Forge (Web Upgraded)",
    generated_at:now, seed,
    name:`System ${seed.split('-')[0].toUpperCase()}`, preset_used:preset, theme:"Classic Clean",
    system_stats:{ star_count:stars.length, planet_count:planets.length, moon_count:moonTotal, belt_count:belts.length, habitable_worlds:habitable },
    stars, planets, belts, notes:""
  };
}

/*** Canvas renderer (Hi‚ÄëDPI, glows, stripes, belt dots) ***/
const map = document.getElementById('map');
function setupHiDPI(canvas){
  const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  const size = Math.min(canvas.parentElement.clientWidth-12, 900);
  canvas.style.width = size+"px"; canvas.style.height = size+"px";
  canvas.width = Math.floor(size * dpr); canvas.height = Math.floor(size * dpr);
  const ctx = canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
  return {ctx, size};
}
function drawStar(ctx, cx, cy, r, color){
  const g=ctx.createRadialGradient(cx,cy,0,cx,cy,r*3);
  g.addColorStop(0, color); g.addColorStop(1, "rgba(255,255,255,0)");
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy,r*3,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle=color; ctx.fill();
  ctx.lineWidth=1; ctx.strokeStyle="#000"; ctx.stroke();
}
function drawGasGiant(ctx, x, y, r){
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle="#FBC02D"; ctx.fill(); ctx.strokeStyle="#000"; ctx.stroke();
  ctx.save(); ctx.clip(); ctx.lineWidth=3; ctx.strokeStyle="#E65100";
  for(let i=-r;i<=r;i+=6){ ctx.beginPath(); ctx.ellipse(x,y+i/3, r, r/6, 0, 0, Math.PI*2); ctx.stroke(); }
  ctx.restore();
}
function drawRings(ctx, x, y, r){
  ctx.strokeStyle="rgba(204,204,204,.9)"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.ellipse(x,y,r+6,r+3,0,0,Math.PI*2); ctx.stroke();
}
function drawBeltDots(ctx, cx, cy, rad){
  const dots=80, a0=Math.random()*Math.PI*2;
  ctx.fillStyle="rgba(200,200,200,.9)";
  for(let i=0;i<dots;i++){
    const a=a0 + i*(Math.PI*2/dots) + Math.random()*0.05;
    const rr = rad + (Math.random()*6-3);
    ctx.fillRect(cx + rr*Math.cos(a), cy + rr*Math.sin(a), 1.5, 1.5);
  }
}
function drawSystem(canvas, data, selectedId=null){
  const {ctx, size} = setupHiDPI(canvas);
  const W=size, H=size, cx=W/2, cy=H/2;
  ctx.fillStyle="#0b111a"; ctx.fillRect(0,0,W,H);

  // stars
  (data.stars||[]).forEach((s, i)=>{
    const color = STAR_COLORS[s.spectral_class] || "#FFD54F";
    const r = (i===0?10:6);
    drawStar(ctx, cx, cy, r, color);
  });

  // planets
  const planets=data.planets||[];
  const maxOrbit = Math.max(1, ...planets.map(p=>p.orbit_index));
  const maxR = Math.min(W,H)/2 - 60;
  const positions = {};
  planets.forEach(p=>{
    const r = (p.orbit_index / maxOrbit) * maxR;
    // orbit
    ctx.setLineDash([4,3]); ctx.strokeStyle="#667"; ctx.lineWidth=1;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
    ctx.setLineDash([]);

    // position angle
    const h = [...p.id].reduce((a,c)=>a + c.charCodeAt(0), 0);
    const ang = (h % 360) * Math.PI/180;
    const px = cx + r*Math.cos(ang), py = cy + r*Math.sin(ang);
    positions[p.id] = {x:px,y:py, radius:({tiny:4, small:6, medium:8, large:12}[p.size_band]||6)};

    // highlight selection
    if(selectedId===p.id){
      ctx.beginPath(); ctx.arc(px,py, positions[p.id].radius+10, 0, Math.PI*2);
      ctx.strokeStyle="#5cc8ff"; ctx.lineWidth=2; ctx.stroke();
    }

    // draw planet
    if(p.class==="gas"){ drawGasGiant(ctx, px, py, positions[p.id].radius); }
    else {
      ctx.beginPath(); ctx.arc(px,py,positions[p.id].radius,0,Math.PI*2);
      ctx.fillStyle = PLANET_COLORS[p.class] || "#4FC3F7"; ctx.fill();
      ctx.strokeStyle="#000"; ctx.stroke();
    }
    if(p.rings) drawRings(ctx, px, py, positions[p.id].radius);

    // moons (simple)
    (p.moons||[]).slice(0,6).forEach((m,i)=>{
      const mAng = ang + (i+1)*Math.PI/6;
      const mr = positions[p.id].radius + 10;
      const mx = px + mr*Math.cos(mAng), my= py + mr*Math.sin(mAng);
      ctx.beginPath(); ctx.arc(mx,my,2,0,Math.PI*2); ctx.fillStyle="#AAA"; ctx.fill();
    });
  });

  // asteroid belt (if any)
  (data.belts||[]).forEach((b, i)=>{
    const beltRad = (Math.min(...planets.map(p=>p.orbit_index)) + (maxOrbit/2)) / maxOrbit * maxR;
    drawBeltDots(ctx, cx, cy, beltRad);
  });

  return positions; // for hit-testing
}

/*** Exports ***/
function exportJSON(data){
  const blob = new Blob([JSON.stringify(data, null, 2) + "\n"], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:`${data.name}-${data.seed}.json`});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function exportCSV(data){
  const cols = ["System_Name","Seed","Preset","Theme","Body_Type","Body_ID","Parent_ID","Orbit_Index","Orbit_Dist_Band","Role","Spectral_Class","Mass_Band","Luminosity_Band","Radius_Band","Color_Hint","Class","Size_Band","Density_Band","Atmosphere","Surface_Water","Gravity_Band","Temperature_Band","Habitability_Score","Rings","Moon_Count","POI_Count","POI_List","Notes"];
  const rows=[cols];
  const sysname=data.name||"", seed=data.seed||"", preset=data.preset_used||"", theme=data.theme||"", notes=data.notes||"";
  (data.stars||[]).forEach(s=>{
    rows.push([sysname,seed,preset,theme,"Star",s.id,"","","",s.role,s.spectral_class,s.mass_band,s.luminosity_band,s.radius_band,s.color_hint,"","","","","","","","","","","0","","",notes]);
  });
  (data.planets||[]).forEach(p=>{
    const poiList=(p.pois||[]).map(x=>x.name).join(";");
    rows.push([sysname,seed,preset,theme,"Planet",p.id,p.parent_star_id,p.orbit_index,"","","",p.mass_band,"",p.density_band,"",p.class,p.size_band,p.density_band,p.atmosphere,p.surface_water,p.gravity_band,p.temperature_band,p.habitability_score,(p.rings?"Y":"N"),(p.moons||[]).length,(p.pois||[]).length,poiList,notes]);
    (p.moons||[]).forEach((m,i)=>{
      const poiListM=(m.pois||[]).map(x=>x.name).join(";");
      rows.push([sysname,seed,preset,theme,"Moon",m.id,p.id,(i+1),m.orbit_dist_band,"","","","","","","",m.class,"","","","","","",0,"",0,(m.pois||[]).length,poiListM,notes]);
    });
  });
  (data.belts||[]).forEach(b=>{
    rows.push([sysname,seed,preset,theme,"Belt",b.id,"","","","","","","","","",b.type,"","","","","","","","",0,"",0,"",b.composition_hint||""]);
  });
  const csv = rows.map(r=>r.map(cell=>{
    const s=String(cell??""); return /[",\n,]/.test(s) ? '"'+s.replaceAll('"','""')+'"' : s;
  }).join(",")).join("\n")+"\n";
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:`${sysname}-${seed}.csv`});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function exportPNG(canvas, data, scale=2){
  const tmp = document.createElement('canvas');
  const size = Math.min(canvas.parentElement.clientWidth-12, 900);
  tmp.width = size*scale; tmp.height = size*scale;
  const ctx = tmp.getContext('2d'); ctx.scale(scale,scale);
  drawSystem(tmp, currentSystem, selectedId);
  tmp.toBlob(blob=>{
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:`${data.name}-${data.seed}.png`});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
}

/*** App wiring ***/
const seedEl = document.getElementById('seed');
const presetEl = document.getElementById('preset');
const btnReroll = document.getElementById('btnReroll');
const btnGen = document.getElementById('btnGenerate');
const btnLegend = document.getElementById('btnLegend');
const btnJSON = document.getElementById('btnExportJSON');
const btnCSV = document.getElementById('btnExportCSV');
const btnPNG = document.getElementById('btnExportPNG');
const stats = document.getElementById('stats');
const legend = document.getElementById('legend');
const sheet = document.getElementById('detailSheet');
const dTitle = document.getElementById('detailTitle');
const dClass = document.getElementById('dClass');
const dBands = document.getElementById('dBands');
const dAtmos = document.getElementById('dAtmos');
const dTemp = document.getElementById('dTemp');
const dWater = document.getElementById('dWater');
const dGrav = document.getElementById('dGrav');
const dHab = document.getElementById('dHab');
const dPOIs = document.getElementById('dPOIs');
const btnCopy = document.getElementById('btnCopy');
const btnClose = document.getElementById('btnClose');

let currentSystem = null;
let selectedId = null;
let lastPositions = null;

function updateStats(sys){
  const s = sys.system_stats;
  stats.textContent = `Stars: ${s.star_count} ‚Ä¢ Planets: ${s.planet_count} ‚Ä¢ Moons: ${s.moon_count} ‚Ä¢ Belts: ${s.belt_count} ‚Ä¢ Habitable: ${s.habitable_worlds}`;
}
function resizeCanvas(){
  lastPositions = drawSystem(map, currentSystem || generateSystem(seedEl.value, presetEl.value), selectedId);
}
function generateAndRender(){
  const seed = seedEl.value.trim() || "DEFAULT-SEED";
  const preset = presetEl.value;
  currentSystem = generateSystem(seed, preset);
  selectedId = null;
  lastPositions = drawSystem(map, currentSystem, selectedId);
  updateStats(currentSystem);
}
function openDetails(p){
  dTitle.textContent = `${p.id} ‚Äî ${p.class}`;
  dClass.textContent = `${p.class}`;
  dBands.textContent = `size ${p.size_band}, mass ${p.mass_band}, density ${p.density_band}`;
  dAtmos.textContent = p.atmosphere;
  dTemp.textContent = p.temperature_band;
  dWater.textContent = p.surface_water;
  dGrav.textContent = p.gravity_band;
  const hab = p.habitability_score;
  dHab.textContent = `${hab}`;
  dHab.className = 'hab ' + (hab>=60 ? 'good' : hab>=30 ? 'ok' : 'bad');
  dPOIs.innerHTML = (p.pois||[]).length ? (p.pois.map(x=>`<div>‚Ä¢ <b>${x.category}</b>: ${x.name} ‚Äî <i>${x.hook}</i></div>`).join('')) : '<i>None</i>';
  sheet.classList.add('show');
}
btnCopy.addEventListener('click', ()=>{
  if(!currentSystem || !selectedId) return;
  const p = currentSystem.planets.find(x=>x.id===selectedId);
  if(!p) return;
  const text = `${p.id} (${p.class}) ‚Äî size ${p.size_band}, mass ${p.mass_band}, density ${p.density_band}, atmos ${p.atmosphere}, water ${p.surface_water}, grav ${p.gravity_band}, temp ${p.temperature_band}, habitability ${p.habitability_score}`;
  navigator.clipboard?.writeText(text);
});
btnClose.addEventListener('click', ()=> sheet.classList.remove('show'));

btnReroll.addEventListener('click', ()=>{
  const tag = Math.floor(Math.random()*90000+10000);
  const base = (seedEl.value.trim() || "SEED").split("-")[0].toUpperCase();
  seedEl.value = `${base}-${tag}`;
});
btnGen.addEventListener('click', generateAndRender);
btnLegend.addEventListener('click', ()=>legend.classList.toggle('hidden'));
btnJSON.addEventListener('click', ()=> currentSystem && exportJSON(currentSystem));
btnCSV.addEventListener('click', ()=> currentSystem && exportCSV(currentSystem));
btnPNG.addEventListener('click', ()=> currentSystem && exportPNG(map, currentSystem, 2));
window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', resizeCanvas);

// hit‚Äëtesting for planet taps/clicks
map.addEventListener('click', (ev)=>{
  if(!currentSystem || !lastPositions) return;
  const rect = map.getBoundingClientRect();
  const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  // account for CSS scaling
  const px = (ev.clientX - rect.left);
  const py = (ev.clientY - rect.top);
  // positions are in CSS pixels (we draw with transform), so direct compare works
  let best=null, bestDist=1e9;
  for(const p of currentSystem.planets){
    const pos = lastPositions[p.id]; if(!pos) continue;
    const dx = px - pos.x, dy = py - pos.y;
    const dist = Math.hypot(dx,dy);
    if(dist < bestDist){ bestDist=dist; best = p; }
  }
  if(best && bestDist <= (lastPositions[best.id].radius + 14)){
    selectedId = best.id;
    lastPositions = drawSystem(map, currentSystem, selectedId);
    openDetails(best);
  }
});

// initial
generateAndRender();
</script>
</body>
</html>
